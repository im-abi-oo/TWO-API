name: Build, Test, and Sync Go Module

on:
  push:
    branches:
      - main
    paths:
      - '**/*.go'  # فقط زمانی که فایل‌های Go تغییر کنند، ورکفلو اجرا شود
  workflow_dispatch:  # Allow for manual triggering

permissions:
  contents: write  # Allows GitHub Actions to push changes to the repository

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Go environment (specify the version, here we use 1.24)
      - name: Set up Go 1.24
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      # Step 3: Initialize go.mod if it doesn't exist
      - name: Initialize go.mod if it doesn't exist
        run: |
          if [ ! -f go.mod ]; then
            echo "go.mod not found. Initializing go.mod..."
            go mod init ${GITHUB_REPOSITORY}  # Initialize go.mod with the repo name
          fi

      # Step 4: Install dependencies and tidy go.mod
      - name: Install dependencies and tidy go.mod
        run: |
          go get ./...  # Install dependencies
          go mod tidy  # Clean up unused dependencies and update go.mod and go.sum

      # Step 5: Run tests to make sure everything works
      - name: Run tests
        run: |
          go test -v ./...  # Run the tests to ensure everything works correctly

      # Step 6: Upload the built binary artifact
      - name: Upload built binary
        uses: actions/upload-artifact@v3.1.0  # Use the correct version of upload-artifact
        with:
          name: myapp-binary
          path: myapp  # Upload the built binary
